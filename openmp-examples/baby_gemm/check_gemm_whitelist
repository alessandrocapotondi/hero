#!/bin/python3
import sys

if len(sys.argv) != 2:
  print("Error: compiler output file required!")
  sys.exit(2)

compilation = sys.argv[1]
script = 'compile_and_send'

with open(compilation, 'r') as f:
  lines = f.read().split('\n')

gemms = ""
for line in lines:
  if 'blacklisted' in line and 'gemm' in line:
    gemms+=line.split(' ')[5]+'\n'

if gemms == "":
  print("No blacklisted gemm layers detected")
  sys.exit(0)

print("Detected the following blacklisted gemm kernels:\n", gemms)
output='#!/bin/bash\n\
\n\
### THIS FILE IS AUTOGENERATED BY check_gemm_whitelist ###\n\
set -o errexit\n\
\n\
\n\
## Comment out the region below to avoid PREM compilation ##\n\
export HERCULES_INSTALL=${HERO_INSTALL}\n\
export HERCULES_ARCH="PULP"\n\
export HERCULES_FORCE_FOOTPRINT_DENSE=1\n\
export HERCULES_CPU_MEMORY_SIZE=32768\n\
export HERCULES_DEFAULT_NUM_THREADS=8\n\
export HERCULES_DMA_ENFORCE\n\
export HERCULES_NO_INTERVAL_CONTROLFLOW\n\
export HERCULES_WHITELIST="main gemm_nn gemm_cpu gemm\n\
' + gemms + '.omp_outlined.\n\
.omp_outlined..1\n\
.omp_outlined..2\n\
.omp_outlined..3\n\
.omp_outlined..4\n\
.omp_outlined..5\n\
.omp_outlined..6\n\
.omp_outlined..7\n\
.omp_outlined..8\n\
.omp_outlined..9\n\
.omp_outlined..10\n\
.omp_outlined..11\n\
.omp_outlined..12\n\
.omp_outlined..13"\n\
source ${HERCULES_INSTALL}/../toolchain/HerculesCompiler-public/environment.sh\n\
## End of region to be commented out\n\
\n\
\n\
source ${HERO_INSTALL}/../env/exilzcu102.sh\n\
make default-as=pulp clean all\n\
scp baby_gemm root@hero-zcu102-06:/home/root/mmaxim/'

with open(script, 'w') as f:
  f.write(output)
sys.exit(1)
